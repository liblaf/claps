import functools
import re
from typing import Optional

from gsc.conf import outbound as _outbound

PROVIDER2PATTERN: dict[str, dict[str, str]] = {
    "default": {
        "ðŸ‡¦ðŸ‡· AR é˜¿æ ¹å»·": r"ðŸ‡¦ðŸ‡·|\bAR\b|é˜¿æ ¹å»·",
        "ðŸ‡¦ðŸ‡º AU æ¾³å¤§åˆ©äºš": r"ðŸ‡¦ðŸ‡º|\bAU\b|æ¾³å¤§åˆ©äºš",
        "ðŸ‡§ðŸ‡· BR å·´è¥¿": r"ðŸ‡§ðŸ‡·|\bBR\b|å·´è¥¿",
        "ðŸ‡¨ðŸ‡¦ CA åŠ æ‹¿å¤§": r"ðŸ‡¨ðŸ‡¦|\bCA\b|åŠ æ‹¿å¤§",
        "ðŸ‡¨ðŸ‡­ CH ç‘žå£«": r"ðŸ‡¨ðŸ‡­|\bCH\b|ç‘žå£«",
        "ðŸ‡©ðŸ‡ª DE å¾·å›½": r"ðŸ‡©ðŸ‡ª|\bDE\b|å¾·å›½",
        "ðŸ‡ªðŸ‡¸ ES è¥¿ç­ç‰™": r"ðŸ‡ªðŸ‡¸|\bES\b|è¥¿ç­ç‰™",
        "ðŸ‡«ðŸ‡· FR æ³•å›½": r"ðŸ‡«ðŸ‡·|\bFR\b|æ³•å›½",
        "ðŸ‡¬ðŸ‡§ UK è‹±å›½": r"ðŸ‡¬ðŸ‡§|\bUK\b|è‹±å›½",
        "ðŸ‡­ðŸ‡° HK é¦™æ¸¯": r"ðŸ‡­ðŸ‡°|\bHK\b|æ¸¯",
        "ðŸ‡®ðŸ‡ª IE çˆ±å°”å…°": r"ðŸ‡®ðŸ‡ª|\bIE\b|çˆ±å°”å…°",
        "ðŸ‡®ðŸ‡± IL ä»¥è‰²åˆ—": r"ðŸ‡®ðŸ‡±|\bIL\b|ä»¥è‰²åˆ—",
        "ðŸ‡®ðŸ‡³ IN å°åº¦": r"ðŸ‡®ðŸ‡³|\bIN\b|å°åº¦",
        "ðŸ‡¯ðŸ‡µ JP æ—¥æœ¬": r"ðŸ‡¯ðŸ‡µ|\bJP\b|æ—¥|ä¸œäº¬",
        "ðŸ‡°ðŸ‡· KR éŸ©å›½": r"ðŸ‡°ðŸ‡·|\bKR\b|éŸ©å›½",
        "ðŸ‡³ðŸ‡± NL è·å…°": r"ðŸ‡³ðŸ‡±|\bNL\b|è·å…°",
        "ðŸ‡³ðŸ‡´ NO æŒªå¨": r"ðŸ‡³ðŸ‡´|\bNO\b|æŒªå¨",
        "ðŸ‡·ðŸ‡º RU ä¿„ç½—æ–¯": r"ðŸ‡·ðŸ‡º|\bRU\b|ä¿„ç½—æ–¯",
        "ðŸ‡·ðŸ‡º SG æ–°åŠ å¡": r"ðŸ‡·ðŸ‡º|\bSG\b|æ–°",
        "ðŸ‡¸ðŸ‡ª SE ç‘žå…¸": r"ðŸ‡¸ðŸ‡ª|\bSE\b|ç‘žå…¸",
        "ðŸ‡¹ðŸ‡­ TH æ³°å›½": r"ðŸ‡¹ðŸ‡­|\bTH\b|æ³°å›½",
        "ðŸ‡¹ðŸ‡· TR åœŸè€³å…¶": r"ðŸ‡¹ðŸ‡·|\bTR\b|åœŸè€³å…¶",
        "ðŸ‡¹ðŸ‡¼ TW å°æ¹¾": r"ðŸ‡¹ðŸ‡¼|\bTW\b|å°",
        "ðŸ‡ºðŸ‡¦ UA ä¹Œå…‹å…°": r"ðŸ‡ºðŸ‡¦|\bUA\b|ä¹Œå…‹å…°",
        "ðŸ‡ºðŸ‡¸ US ç¾Žå›½": r"ðŸ‡ºðŸ‡¸|\bUS\b|ç¾Ž",
        "ðŸ‡¿ðŸ‡¦ ZA å—éž": r"ðŸ‡¿ðŸ‡¦|\bZA\b|å—éž",
    },
    "FastLink": {
        "ðŸ‡¦ðŸ‡· AR é˜¿æ ¹å»·": r"é˜¿æ ¹å»·",
        "ðŸ‡¦ðŸ‡º AU æ¾³å¤§åˆ©äºš": r"æ¾³å¤§åˆ©äºš",
        "ðŸ‡§ðŸ‡· BR å·´è¥¿": r"å·´è¥¿",
        "ðŸ‡¨ðŸ‡¦ CA åŠ æ‹¿å¤§": r"åŠ æ‹¿å¤§",
        "ðŸ‡©ðŸ‡ª DE å¾·å›½": r"å¾·å›½",
        "ðŸ‡«ðŸ‡· FR æ³•å›½": r"æ³•å›½",
        "ðŸ‡¬ðŸ‡§ UK è‹±å›½": r"è‹±å›½",
        "ðŸ‡­ðŸ‡° HK é¦™æ¸¯": r"é¦™æ¸¯|å¹¿æ¸¯",
        "ðŸ‡®ðŸ‡³ IN å°åº¦": r"å°åº¦",
        "ðŸ‡¯ðŸ‡µ JP æ—¥æœ¬": r"æ—¥æœ¬|å¹¿æ—¥",
        "ðŸ‡°ðŸ‡· KR éŸ©å›½": r"éŸ©å›½",
        "ðŸ‡³ðŸ‡± NL è·å…°": r"è·å…°",
        "ðŸ‡·ðŸ‡º RU ä¿„ç½—æ–¯": r"ä¿„ç½—æ–¯",
        "ðŸ‡·ðŸ‡º SG æ–°åŠ å¡": r"æ–°åŠ å¡|å¹¿æ–°",
        "ðŸ‡¹ðŸ‡­ TH æ³°å›½": r"æ³°å›½",
        "ðŸ‡¹ðŸ‡· TR åœŸè€³å…¶": r"åœŸè€³å…¶",
        "ðŸ‡¹ðŸ‡¼ TW å°æ¹¾": r"å°æ¹¾|å¹¿å°",
        "ðŸ‡ºðŸ‡¸ US ç¾Žå›½": r"ç¾Žå›½|å¹¿ç¾Ž",
    },
    "FlyingBird": {
        "ðŸ‡¦ðŸ‡· AR é˜¿æ ¹å»·": r"Argentina-\d{2}",
        "ðŸ‡¬ðŸ‡§ UK è‹±å›½": r"UK-\d{2}",
        "ðŸ‡­ðŸ‡° HK é¦™æ¸¯": r"Hong Kong-\d{2}",
        "ðŸ‡¯ðŸ‡µ JP æ—¥æœ¬": r"Japan-\d{2}",
        "ðŸ‡²ðŸ‡¾ MY é©¬æ¥è¥¿äºš": r"Malaysia-\d{2}",
        "ðŸ‡·ðŸ‡º SG æ–°åŠ å¡": r"Singapore-\d{2}",
        "ðŸ‡¹ðŸ‡· TR åœŸè€³å…¶": r"Turkey-\d{2}",
        "ðŸ‡¹ðŸ‡¼ TW å°æ¹¾": r"Taiwan-\d{2}",
        "ðŸ‡ºðŸ‡¸ US ç¾Žå›½": r"USA-\d{2}",
    },
    "NTHU.CC": {
        "ðŸ‡¬ðŸ‡§ UK è‹±å›½": r"è‹±å›½",
        "ðŸ‡­ðŸ‡° HK é¦™æ¸¯": r"é¦™æ¸¯",
        "ðŸ‡¯ðŸ‡µ JP æ—¥æœ¬": r"ä¸œäº¬",
        "ðŸ‡°ðŸ‡· KR éŸ©å›½": r"éŸ©å›½",
        "ðŸ‡·ðŸ‡º SG æ–°åŠ å¡": r"æ–°åŠ å¡",
        "ðŸ‡¹ðŸ‡· TR åœŸè€³å…¶": r"åœŸè€³å…¶",
        "ðŸ‡¹ðŸ‡¼ TW å°æ¹¾": r"å°æ¹¾",
        "ðŸ‡ºðŸ‡¸ US ç¾Žå›½": r"ç¾Žå›½",
    },
}


@functools.cache
def country(outbound: _outbound.Outbound) -> Optional[str]:
    match: Optional[re.Match[str]] = re.fullmatch(
        r"(?P<tag>.+) \[(?P<provider>.+)\]", outbound.tag
    )
    tag: str
    pattern: dict[str, str]
    if match:
        tag = match.group("tag")
        provider: str = match.group("provider")
        pattern = PROVIDER2PATTERN.get(provider, PROVIDER2PATTERN["default"])
    else:
        tag = outbound.tag
        pattern = PROVIDER2PATTERN["default"]
    for country, regex in pattern.items():
        if re.search(regex, tag):
            return country
